#!/bin/bash

DEVICE=/dev/ttyOUT2
BAUD=115200

# Setup device
stty -F $DEVICE cs8 $BAUD ignbrk -brkint -icrnl -imaxbel -opost -onlcr -isig -icanon -iexten -echo -echoe -echok -echoctl -echoke noflsh -ixon -crtscts

# Main loop
echo "Type 'exit' to end the session."
while true; do
    echo -n "Enter AT Command: "
    read user_input

    # Exit condition
    if [[ "$user_input" == "exit" ]]; then
        echo "Exiting..."
        break
    fi

    # Send command to device
    echo -e "$user_input\r" > $DEVICE &

    # Read output in the background
    (cat $DEVICE > /tmp/response & PID=$!
        # Wait for "OK" or "ERROR" to appear in the output
        while ! grep -qe "OK" -e "ERROR" /tmp/response; do
            sleep 0.5
        done

        # Kill the background reading process
        kill $PID

        # Print the response
        cat /tmp/response
        # Cleanup
        > /tmp/response
    ) &
    wait $!
done
